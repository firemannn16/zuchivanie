<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>–¢—Ä–µ–Ω–∞–∂—ë—Ä –∞—Ä–∞–±—Å–∫–∏—Ö —Å–ª–æ–≤ ‚Äî –ó–∞—É—á–∏–≤–∞–Ω–∏–µ + –ü—Ä–∞–∫—Ç–∏–∫–∞</title>
<style>
  :root{--bg:#ffffff;--muted:#666;--accent:#0a6;--danger:#c33}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111;margin:18px;max-width:980px}
  #wrap{margin:0 auto}
  h1{margin:6px 0 12px}
  .dua{background:#fff;padding:14px;border-radius:10px;border:1px solid #eee;margin-bottom:12px}
  .dua .arab{direction:rtl;font-size:2.2rem;font-weight:700;margin:8px 0;text-align:center}
  .card{background:#fff;padding:18px;border-radius:10px;border:1px solid #eee;margin-bottom:12px}
  #arabic{direction:rtl;font-size:2.8rem;text-align:center;min-height:3.6em;display:flex;align-items:center;justify-content:center}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer;font-size:1rem}
  .btn-primary{background:#e6fff0;border-color:#b6f0c7}
  .btn-danger{background:#fff0f0;border-color:#f0b6b6}
  .small{font-size:0.95rem;color:var(--muted);margin-top:8px;text-align:center}
  .stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
  .stat{background:#fafafa;padding:8px 12px;border-radius:8px;border:1px solid #f0f0f0}
  .hidden{display:none}
  input[type="text"]{width:100%;padding:10px;font-size:1rem;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  /* modal */
  .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:18px;border-radius:10px;max-width:720px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
  .modal .arab{direction:rtl;font-size:1.8rem;font-weight:700;text-align:right}
  .modal .rus{margin-top:10px;font-size:1.1rem}
  .right{float:right}
  @media(max-width:640px){
    #arabic{font-size:2.2rem;padding:8px}
    .modal{padding:12px}
  }
</style>
</head>
<body>
  <div id="wrap">
    <h1>–¢—Ä–µ–Ω–∞–∂—ë—Ä –∞—Ä–∞–±—Å–∫–∏—Ö —Å–ª–æ–≤</h1>

    <!-- –î—É–∞ —ç–∫—Ä–∞–Ω (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞—Ö–æ–¥–µ) -->
    <div id="screen-dua" class="dua">
      <div><strong>–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</strong></div>
      <div class="arab">ÿ±ŸéŸëÿ®ŸêŸë ÿ≤ŸêÿØŸíŸÜŸêŸâ ÿπŸêŸÑŸíŸÖŸã€≠ÿß</div>
      <div style="text-align:center;margin-top:6px">–ü–µ—Ä–µ–≤–æ–¥: ¬´–ì–æ—Å–ø–æ–¥—å –º–æ–π! –ü—Ä–∏—É–º–Ω–æ–∂—å –º–æ–∏ –∑–Ω–∞–Ω–∏—è¬ª</div>
      <div class="center" style="margin-top:12px">
        <button id="btn-done-dua">–Ø —Å–¥–µ–ª–∞–ª –¥—É–∞</button>
      </div>
      <div class="small">–°–ª–æ–≤–∞—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ <code>words.txt</code>.</div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div id="screen-main" class="hidden">
      <div class="stats">
        <div class="stat">–í—Å–µ–≥–æ —Å–ª–æ–≤: <span id="stat-total">0</span></div>
        <div class="stat">–£–∂–µ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –≤—ã—É—á–µ–Ω–æ: <span id="stat-mastered">0</span></div>
        <div class="stat">–û—Å—Ç–∞–ª–æ—Å—å –≤ –æ—á–µ—Ä–µ–¥–∏: <span id="stat-remaining">0</span></div>
        <div class="stat">–§–∞–∑–∞: <span id="stat-phase">‚Äî</span></div>
      </div>

      <div class="card">
        <div id="arabic">‚Ä¶</div>

        <div id="learn-controls" class="controls">
          <button id="btn-know" class="btn-primary">–ó–Ω–∞—é</button>
          <button id="btn-dont" class="">–ù–µ –∑–Ω–∞—é</button>
          <button id="btn-add" class="">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞</button>
          <button id="btn-reset" class="btn-danger">–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å</button>
        </div>

        <div id="practice-area" class="hidden" style="margin-top:12px">
          <div style="margin-bottom:8px"><strong>–ü—Ä–∞–∫—Ç–∏–∫–∞ ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º:</strong></div>
          <input id="practice-input" type="text" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥" />
          <div class="center" style="margin-top:8px">
            <button id="practice-submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button id="practice-skip">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–≤–µ—Ä–Ω—É—Ç—å –≤ –ø–æ–≤—Ç–æ—Ä)</button>
          </div>
        </div>

        <div id="message" class="small" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Modal –¥–ª—è "–ù–µ –∑–Ω–∞—é" -->
    <div id="modal-root"></div>
  </div>

<script>
/* ========== –ö–æ–Ω—Ñ–∏–≥ ========= */
const BATCH_SIZE = 10;               // —Å–∫–æ–ª—å–∫–æ —Å–ª–æ–≤ –≤—ã—É—á–∏—Ç—å –≤ –∫–∞–∂–¥–æ–º —Ä–∞—É–Ω–¥–µ –ø–µ—Ä–µ–¥ –ø—Ä–∞–∫—Ç–∏–∫–æ–π
const DONT_KNOW_SHOW_MS = 15000;     // 15 —Å–µ–∫—É–Ω–¥
const AUTO_CLOSE_MODAL_MS = DONT_KNOW_SHOW_MS;
const STORAGE_KEY = (() => {
  const path = (location.pathname||'/').replace(/^\/|\/$/g,'').replace(/\//g,'_') || 'root';
  return `arabic_trainer_state_v1_${encodeURIComponent(location.hostname + '_' + path)}`;
})();

/* ========== –°–æ—Å—Ç–æ—è–Ω–∏–µ ========= */
let allWords = [];           // [{ rawLine, rus: [], arab: "..." }]
let orderQueue = [];         // –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è (rawLine strings)
let masteredFinal = [];      // –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –≤—ã—É—á–µ–Ω–Ω—ã–µ rawLine's (—É–¥–∞–ª—è—é—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞)
let roundMastered = [];      // –≤—ã—É—á–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–º —Ä–∞—É–Ω–¥–µ (rawLine)
let practiceAccum = [];      // –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏ (–æ—á–µ—Ä–µ–¥—å, grows each round)
let practiceOrder = [];      // —Ç–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å –ø—Ä–∞–∫—Ç–∏–∫–∏ (rawLines)
let phase = 'learn';         // 'learn' –∏–ª–∏ 'practice'
let currentRaw = null;
let modalTimer = null;

/* ========== DOM ========= */
const screenDua = document.getElementById('screen-dua');
const screenMain = document.getElementById('screen-main');
const btnDoneDua = document.getElementById('btn-done-dua');

const statTotal = document.getElementById('stat-total');
const statMastered = document.getElementById('stat-mastered');
const statRemaining = document.getElementById('stat-remaining');
const statPhase = document.getElementById('stat-phase');

const arabicDiv = document.getElementById('arabic');
const btnKnow = document.getElementById('btn-know');
const btnDont = document.getElementById('btn-dont');
const btnAdd = document.getElementById('btn-add');
const btnReset = document.getElementById('btn-reset');
const messageDiv = document.getElementById('message');

const practiceArea = document.getElementById('practice-area');
const practiceInput = document.getElementById('practice-input');
const practiceSubmit = document.getElementById('practice-submit');
const practiceSkip = document.getElementById('practice-skip');

const modalRoot = document.getElementById('modal-root');

/* ========== –£—Ç–∏–ª–∏—Ç—ã ========= */
function normalizeLine(l){
  if(!l) return '';
  return l.replace(/^\uFEFF/,'').replace(/[\u2010\u2011\u2012\u2013\u2014\u2015‚Äì‚Äî‚àí]/g,'-').replace(/\s+/g,' ').trim();
}
function parseLine(raw){
  raw = normalizeLine(raw);
  const parts = raw.split(/[-‚Äì‚Äî]/);
  const left = (parts[0]||'').trim();
  const right = parts.slice(1).join('-').trim();
  const rus = left ? left.split(',').map(s=>s.trim()).filter(Boolean) : [''];
  return { rawLine: raw, rus, arab: right };
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }

/* ========== –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ========= */
function saveState(){
  try{
    const st = {
      allRaw: allWords.map(w=>w.rawLine),
      orderQueue: orderQueue.slice(),
      masteredFinal: masteredFinal.slice(),
      roundMastered: roundMastered.slice(),
      practiceAccum: practiceAccum.slice(),
      practiceOrder: practiceOrder.slice(),
      phase,
      currentRaw
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  }catch(e){ console.warn('saveState error', e); }
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}

function clearState(){
  try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}
}

/* ========== –ó–∞–≥—Ä—É–∑–∫–∞ words.txt (robust) ========= */
async function robustFetchWords(){
  const tries = ['words.txt','./words.txt'];
  try{ tries.push(location.pathname.replace(/\/[^/]*$/,'/') + 'words.txt'); }catch(e){}
  for(const p of tries){
    try{
      const r = await fetch(p);
      if(r.ok) return await r.text();
    }catch(e){}
  }
  // try raw.githubusercontent (assumes repo layout /main/words.txt)
  try{
    const user = location.hostname.split('.')[0] || '';
    const repo = (location.pathname.split('/').filter(Boolean)[0] || '');
    if(user && repo){
      const raw = `https://raw.githubusercontent.com/${user}/${repo}/main/words.txt`;
      const r2 = await fetch(raw);
      if(r2.ok) return await r2.text();
    }
  }catch(e){}
  throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å words.txt');
}

/* ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–≤–∞—Ä—è / –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ========= */
async function initDictionary(){
  try{
    const txt = await robustFetchWords();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    // parse to objects
    const parsed = lines.map(parseLine);
    // merge with possibly saved snapshot that contains older lines
    const st = loadState();
    if(st && Array.isArray(st.allRaw) && st.allRaw.length){
      // if state exists, we will try to restore using raw lines approach
      // start with server parsed, then keep state values if raw lines still exist
      allWords = parsed.slice();
      const serverSet = new Set(allWords.map(w=>w.rawLine));
      // restore fields
      orderQueue = (Array.isArray(st.orderQueue) ? st.orderQueue.filter(r=>serverSet.has(r)) : []);
      // append server-new lines which were not in saved snapshot
      const oldSnap = new Set(st.allRaw || []);
      const newOnServer = allWords.map(w=>w.rawLine).filter(r => !oldSnap.has(r));
      for(const r of newOnServer){
        if(!orderQueue.includes(r)) orderQueue.push(r);
      }
      masteredFinal = (Array.isArray(st.masteredFinal) ? st.masteredFinal.filter(r=>serverSet.has(r)) : []);
      roundMastered = (Array.isArray(st.roundMastered) ? st.roundMastered.filter(r=>serverSet.has(r)) : []);
      practiceAccum = (Array.isArray(st.practiceAccum) ? st.practiceAccum.filter(r=>serverSet.has(r)) : []);
      practiceOrder = (Array.isArray(st.practiceOrder) ? st.practiceOrder.filter(r=>serverSet.has(r)) : []);
      phase = st.phase || 'learn';
      currentRaw = (st.currentRaw && serverSet.has(st.currentRaw)) ? st.currentRaw : null;
      // if orderQueue empty, initialize it from allWords excluding masteredFinal
      if(!orderQueue.length){
        orderQueue = allWords.map(w=>w.rawLine).filter(r => !masteredFinal.includes(r));
        shuffle(orderQueue);
      }
    } else {
      allWords = parsed.slice();
      masteredFinal = [];
      roundMastered = [];
      practiceAccum = [];
      practiceOrder = [];
      phase = 'learn';
      currentRaw = null;
      orderQueue = allWords.map(w=>w.rawLine);
      shuffle(orderQueue);
    }
    updateStats();
    saveState();
  }catch(err){
    console.error('initDictionary failed', err);
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å words.txt: ' + err.message);
  }
}

/* ========== UI –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ========= */
function updateStats(){
  statTotal.textContent = allWords.length;
  statMastered.textContent = masteredFinal.length;
  statRemaining.textContent = orderQueue.length;
  statPhase.textContent = phase === 'learn' ? '–ó–∞—É—á–∏–≤–∞–Ω–∏–µ' : '–ü—Ä–∞–∫—Ç–∏–∫–∞';
}

function showMessage(t){
  messageDiv.textContent = t || '';
}

/* ========== –ü–æ–∫–∞–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è ========= */
function showNextLearn(){
  phase = 'learn';
  updateStats();
  if(orderQueue.length === 0){
    // –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî –∑–Ω–∞—á–∏—Ç –ª–∏–±–æ –≤—Å—ë –≤—ã—É—á–µ–Ω–æ, –ª–∏–±–æ practice –æ—Å—Ç–∞–ª–æ—Å—å
    if(practiceOrder.length === 0 && practiceAccum.length === 0){
      showMessage('–ü–æ–∑–¥—Ä–∞–≤–ª—è—é ‚Äî –≤—Å–µ —Å–ª–æ–≤–∞ –ø—Ä–æ–π–¥–µ–Ω—ã!');
      arabicDiv.textContent = 'üéâ –í—Å—ë –ø—Ä–æ–π–¥–µ–Ω–æ';
      saveState();
      return;
    } else {
      // –µ—Å–ª–∏ –µ—Å—Ç—å —á—Ç–æ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤–∞—Ç—å ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –≤ practice
      startPractice();
      return;
    }
  }
  currentRaw = orderQueue.shift();
  saveState();
  const obj = allWords.find(w=>w.rawLine===currentRaw) || { rawLine: currentRaw, rus:[''], arab: '' };
  arabicDiv.textContent = obj.arab || '[–Ω–µ—Ç –∞—Ä–∞–±—Å–∫–æ–π —Ñ–æ—Ä–º—ã]';
  showMessage('–ù–∞–∂–º–∏—Ç–µ "–ó–Ω–∞—é" –∏–ª–∏ "–ù–µ –∑–Ω–∞—é".');
  practiceArea.classList.add('hidden');
  updateStats();
}

/* ========== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∑–∞—É—á–∏–≤–∞–Ω–∏—è ========= */
btnKnow.addEventListener('click', () => {
  if(!currentRaw) return;
  // –ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤—ã—É—á–µ–Ω–Ω–æ–µ –≤ —ç—Ç–æ–º —Ä–∞—É–Ω–¥–µ; –ø–æ–∫–∞ –Ω–µ —É–¥–∞–ª—è–µ–º –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ ‚Äî –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –≤ –ø—Ä–∞–∫—Ç–∏–∫–µ
  if(!roundMastered.includes(currentRaw)) roundMastered.push(currentRaw);
  // —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –≤ practiceAccum (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏)
  if(!practiceAccum.includes(currentRaw)) practiceAccum.push(currentRaw);
  // –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —ç—Ç–æ —Å–ª–æ–≤–æ –≤ –æ—á–µ—Ä–µ–¥—å ‚Äî –æ–Ω–æ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ learn –ø–æ–∫–∞ –Ω–µ —Å–±—Ä–æ—Å—è—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–ª–∏ –Ω–µ –≤–µ—Ä–Ω—ë—Ç—Å—è –∏–∑ practice
  currentRaw = null;
  updateStats();
  saveState();
  // –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ø–æ—Ä–æ–≥ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–∞–∫—Ç–∏–∫—É
  if(roundMastered.length >= BATCH_SIZE){
    startPractice();
  } else {
    // –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ —Å–ª–æ–≤–æ
    showNextLearn();
  }
});

btnDont.addEventListener('click', () => {
  if(!currentRaw) return;
  // –ø–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª —Å –ø–µ—Ä–µ–≤–æ–¥–∞–º–∏ –∏ –∞—Ä–∞–±—Å–∫–æ–π —Ñ–æ—Ä–º–æ–π –Ω–∞ 15 —Å–µ–∫
  const obj = allWords.find(w=>w.rawLine===currentRaw) || { rawLine: currentRaw, rus:[''], arab: '' };
  showModalDontKnow(obj);
  // –≤–µ—Ä–Ω—É—Ç—å —Å–ª–æ–≤–æ –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏ (—á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–¥–Ω–µ–µ)
  orderQueue.push(currentRaw);
  currentRaw = null;
  saveState();
});

/* ========== –ú–æ–¥–∞–ª–∫–∞ "–ù–µ –∑–Ω–∞—é" ========= */
function showModalDontKnow(obj){
  closeModal();
  const overlay = document.createElement('div'); overlay.className = 'overlay';
  const modal = document.createElement('div'); modal.className = 'modal';
  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center">
      <strong>–ü–µ—Ä–µ–≤–æ–¥ (15 —Å)</strong>
      <button id="modal-close" style="padding:6px 8px;border-radius:6px">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="arab" style="margin-top:8px">${escapeHtml(obj.arab || '')}</div>
    <div class="rus">${escapeHtml((obj.rus||[]).join(', '))}</div>
  `;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);

  function closeHandler(){ cleanup(); }
  function cleanup(){
    if(modalTimer) { clearTimeout(modalTimer); modalTimer = null; }
    const b = document.getElementById('modal-close');
    if(b) b.removeEventListener('click', closeHandler);
    if(overlay.parentNode) overlay.parentNode.removeChild(overlay);
  }

  const closeBtn = document.getElementById('modal-close');
  if(closeBtn) closeBtn.addEventListener('click', closeHandler);
  modalTimer = setTimeout(()=>{ cleanup(); showNextLearn(); }, AUTO_CLOSE_MODAL_MS);
}

/* ========== –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É ========= */
function closeModal(){
  modalRoot.innerHTML = '';
  if(modalTimer){ clearTimeout(modalTimer); modalTimer = null; }
}

/* ========== –ü—Ä–∞–∫—Ç–∏–∫–∞ ========= */
function startPractice(){
  phase = 'practice';
  // practiceOrder ‚Äî –∫–æ–ø–∏—è practiceAccum, shuffle
  practiceOrder = practiceAccum.slice();
  shuffle(practiceOrder);
  // –æ—á–∏—Å—Ç–∏–º roundMastered ‚Äî –æ–Ω–∏ —Ç–µ–ø–µ—Ä—å —á–∞—Å—Ç—å practiceAccum
  roundMastered = [];
  saveState();
  updateStats();
  showNextPractice();
}

function showNextPractice(){
  if(!practiceOrder || practiceOrder.length === 0){
    // practice finished -> back to learning if queue not empty
    practiceAccum = practiceAccum.filter(r => !masteredFinal.includes(r)); // keep only not-final
    // –µ—Å–ª–∏ –≤ practiceAccum –Ω–µ—Ç —Å–ª–æ–≤ –∏ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî –≤—Å—ë –ø—Ä–æ–π–¥–µ–Ω–æ
    if(orderQueue.length === 0 && practiceOrder.length === 0 && practiceAccum.length === 0){
      showMessage('–ü–æ–∑–¥—Ä–∞–≤–ª—è—é ‚Äî –≤—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞!');
      arabicDiv.textContent = 'üéâ –í—Å—ë –≤—ã—É—á–µ–Ω–æ';
      phase = 'done';
      saveState();
      updateStats();
      return;
    }
    // –ø–µ—Ä–µ–π—Ç–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ learn
    phase = 'learn';
    saveState();
    updateStats();
    showNextLearn();
    return;
  }
  // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–æ–≤–æ –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏
  currentRaw = practiceOrder.shift();
  const obj = allWords.find(w=>w.rawLine===currentRaw) || { rawLine: currentRaw, rus:[''], arab: '' };
  arabicDiv.textContent = obj.arab || '[–Ω–µ—Ç –∞—Ä–∞–±—Å–∫–æ–π —Ñ–æ—Ä–º—ã]';
  practiceArea.classList.remove('hidden');
  practiceInput.value = '';
  practiceInput.focus();
  updateStats();
}

/* –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–∫—Ç–∏–∫–∏ (–≤–≤–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ —Ä—É—Å—Å–∫–æ–º) */
practiceSubmit.addEventListener('click', () => {
  if(!currentRaw) return;
  const val = (practiceInput.value||'').trim().toLowerCase();
  if(!val) return;
  const obj = allWords.find(w=>w.rawLine===currentRaw) || { rus: [''] };
  // —Å—á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –≤–µ—Ä–Ω—ã–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –ª—é–±—ã–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º (—É–ø—Ä–æ—â—ë–Ω–Ω–æ, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —á–µ—Ä–µ–∑ toLowerCase())
  const ok = (obj.rus||[]).some(r => r.trim().toLowerCase() === val || r.trim().toLowerCase() === val.replace(/—ë/g,'–µ'));
  if(ok){
    // –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –≤—ã—É—á–µ–Ω–æ
    if(!masteredFinal.includes(currentRaw)) masteredFinal.push(currentRaw);
    // —É–±—Ä–∞—Ç—å –∏–∑ practiceAccum –µ—Å–ª–∏ –µ—Å—Ç—å
    practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
    showMessage('–í–µ—Ä–Ω–æ ‚Äî —Å–ª–æ–≤–æ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã—É—á–µ–Ω–Ω–æ–µ.');
    saveState();
    updateStats();
    // —Å–ª–µ–¥—É—é—â–∏–π
    currentRaw = null;
    practiceInput.value = '';
    showNextPractice();
  } else {
    // –æ—à–∏–±–∫–∞ ‚Üí –≤–µ—Ä–Ω—É—Ç—å –≤ –æ–±—â—É—é –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è
    orderQueue.push(currentRaw);
    // —Ç–∞–∫–∂–µ —É–±—Ä–∞—Ç—å –∏–∑ practiceAccum (–∏–±–æ –≤–µ—Ä–Ω—É–ª–∏ –≤ learn)
    practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
    showMessage('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Å–ª–æ–≤–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è.');
    saveState();
    updateStats();
    currentRaw = null;
    practiceInput.value = '';
    showNextPractice();
  }
});

/* –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Äî –≤–µ—Ä–Ω—É—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å */
practiceSkip.addEventListener('click', () => {
  if(!currentRaw) return;
  orderQueue.push(currentRaw);
  practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
  saveState();
  showMessage('–°–ª–æ–≤–æ –ø—Ä–æ–ø—É—â–µ–Ω–æ –∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è –∑–∞—É—á–∏–≤–∞–Ω–∏—è.');
  currentRaw = null;
  showNextPractice();
});

/* ========== –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ (—Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ) ========= */
btnAdd.addEventListener('click', async () => {
  try{
    const txt = await robustFetchWords();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const existing = new Set(allWords.map(w=>w.rawLine));
    let added = 0;
    for(const l of lines){
      const n = normalizeLine(l);
      if(!existing.has(n)){
        const obj = parseLine(n);
        allWords.push(obj);
        orderQueue.push(obj.rawLine);
        existing.add(n);
        added++;
      }
    }
    if(added) shuffle(orderQueue); // –ø–µ—Ä–µ–º–µ—à–∞—Ç—å –Ω–æ–≤—ã–µ
    saveState();
    updateStats();
    alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö —Å–ª–æ–≤: ' + added);
  }catch(e){
    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–≤–∞: ' + e.message);
  }
});

/* ========== –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ========= */
btnReset.addEventListener('click', () => {
  if(!confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤–µ—Ä–Ω—ë—Ç —Å–ª–æ–≤–∞—Ä—å –≤ –Ω–∞—á–∞–ª–æ.')) return;
  clearState();
  // –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å –∑–∞–Ω–æ–≤–æ (–∑–∞–≥—Ä—É–∑–∏—Ç words.txt –∏ –ø–æ–∫–∞–∂–µ—Ç –¥—É–∞)
  // –ø—Ä–æ—â–µ ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  location.reload();
});

/* ========== Esc –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ (–µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç) ========= */
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ closeModal(); } });

/* ========== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º ========= */
window.addEventListener('beforeunload', saveState);
window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveState(); });

/* ========== –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ ========= */
function escapeHtml(s){ return String(s || '').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ========== –û–±—Ä–∞–±–æ—Ç—á–∏–∫ "–Ø —Å–¥–µ–ª–∞–ª –¥—É–∞" ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å ========= */
btnDoneDua.addEventListener('click', async () => {
  // —Å–∫—Ä—ã—Ç—å –¥—É–∞, –ø–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É
  screenDua.classList.add('hidden');
  screenMain.classList.remove('hidden');
  // –µ—Å–ª–∏ —Å–ª–æ–≤–∞—Ä—å –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
  if(!allWords.length){
    await initDictionary();
  }
  // –µ—Å–ª–∏ currentRaw –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–∞–∑—ã)
  if(phase === 'practice' && practiceOrder.length){
    // –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
    practiceArea.classList.remove('hidden');
    showNextPractice();
  } else {
    practiceArea.classList.add('hidden');
    // –µ—Å–ª–∏ –±—ã–ª currentRaw (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω), –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å; –∏–Ω–∞—á–µ –≤–∑—è—Ç—å —Å–ª–µ–¥—É—é—â–∏–π
    if(currentRaw){
      const o = allWords.find(w=>w.rawLine===currentRaw);
      arabicDiv.textContent = o ? (o.arab || o.rawLine) : currentRaw;
    } else {
      showNextLearn();
    }
  }
});

/* ========== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ª–æ–≤–∞—Ä—å, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥—É–∞ —ç–∫—Ä–∞–Ω ========== */
(async function bootstrap(){
  // –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–æ–≤–∞—Ä—å –∏ –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–æ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏–∏ ‚Äî –ø–æ–∫–∞–∂–µ–º –¥—É–∞
  try{
    await initDictionary();
    // –ø–æ–∫–∞–∑–∞—Ç—å –¥—É–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), main —Å–∫—Ä—ã—Ç
    screenDua.classList.remove('hidden');
    screenMain.classList.add('hidden');
  }catch(e){
    console.error(e);
    alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + e.message);
  }
})();
</script>
</body>
</html>
