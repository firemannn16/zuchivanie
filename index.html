<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Тренажёр арабских слов — Заучивание + Практика</title>
<style>
  :root{--bg:#ffffff;--muted:#666;--accent:#0a6;--danger:#c33}
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:#111;margin:18px;max-width:980px}
  #wrap{margin:0 auto}
  h1{margin:6px 0 12px}
  .dua{background:#fff;padding:14px;border-radius:10px;border:1px solid #eee;margin-bottom:12px}
  .dua .arab{direction:rtl;font-size:2.2rem;font-weight:700;margin:8px 0;text-align:center}
  .card{background:#fff;padding:18px;border-radius:10px;border:1px solid #eee;margin-bottom:12px}
  #arabic{direction:rtl;font-size:2.8rem;text-align:center;min-height:3.6em;display:flex;align-items:center;justify-content:center}
  .controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
  button{padding:10px 14px;border-radius:8px;border:1px solid #ccc;background:#f6f6f6;cursor:pointer;font-size:1rem}
  .btn-primary{background:#e6fff0;border-color:#b6f0c7}
  .btn-danger{background:#fff0f0;border-color:#f0b6b6}
  .small{font-size:0.95rem;color:var(--muted);margin-top:8px;text-align:center}
  .stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:10px}
  .stat{background:#fafafa;padding:8px 12px;border-radius:8px;border:1px solid #f0f0f0}
  .hidden{display:none}
  input[type="text"]{width:100%;padding:10px;font-size:1rem;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  /* modal */
  .overlay{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
  .modal{background:#fff;padding:18px;border-radius:10px;max-width:720px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
  .modal .arab{direction:rtl;font-size:1.6rem;font-weight:700;text-align:right}
  .modal .pair{margin-top:8px;font-size:1.05rem}
  @media(max-width:640px){ #arabic{font-size:2.2rem;padding:8px} .modal{padding:12px} }
</style>
</head>
<body>
  <div id="wrap">
    <h1>Тренажёр арабских слов</h1>

    <!-- Дуа экран -->
    <div id="screen-dua" class="dua">
      <div><strong>Перед началом тренировок</strong></div>
      <div class="arab">رَّبِّ زِدْنِى عِلْمًۭا</div>
      <div style="text-align:center;margin-top:6px">Перевод: «Господь мой! Приумножь мои знания»</div>
      <div class="center" style="margin-top:12px">
        <button id="btn-done-dua">Я сделал дуа</button>
      </div>
      <div class="small">Словарь загружается автоматически из <code>words.txt</code>.</div>
    </div>

    <!-- Основной интерфейс -->
    <div id="screen-main" class="hidden">
      <div class="stats">
        <div class="stat">Всего слов: <span id="stat-total">0</span></div>
        <div class="stat">Окончательно выучено: <span id="stat-mastered">0</span></div>
        <div class="stat">Осталось в очереди: <span id="stat-remaining">0</span></div>
        <div class="stat">Фаза: <span id="stat-phase">—</span></div>
      </div>

      <div class="card">
        <div id="arabic">…</div>

        <!-- ОБРАТИ ВНИМАНИЕ: id="learn-controls" -->
        <div id="learn-controls" class="controls">
          <button id="btn-know" class="btn-primary">Знаю</button>
          <button id="btn-dont">Не знаю</button>
          <button id="btn-add">Добавить новые слова</button>
          <button id="btn-reset" class="btn-danger">Сбросить прогресс</button>
        </div>

        <div id="practice-area" class="hidden" style="margin-top:12px">
          <div style="margin-bottom:8px"><strong>Практика — введите перевод на русском:</strong></div>
          <input id="practice-input" type="text" autocomplete="off" placeholder="Введите перевод" />
          <div class="center" style="margin-top:8px">
            <button id="practice-submit">Проверить</button>
            <button id="practice-skip">Пропустить</button>
          </div>
        </div>

        <div id="message" class="small" style="margin-top:12px"></div>
      </div>
    </div>

    <!-- Modal root -->
    <div id="modal-root"></div>
  </div>

<script>
/* ========== Настройки ========== */
const BATCH_SIZE = 10;
const SHOW_ANSWER_MS = 15000;
const STORAGE_KEY = (() => {
  const path = (location.pathname||'/').replace(/^\/|\/$/g,'').replace(/\//g,'_') || 'root';
  return `arabic_trainer_state_v1_${encodeURIComponent(location.hostname + '_' + path)}`;
})();

/* ========== Состояние ========= */
let allWords = [];
let orderQueue = [];
let masteredFinal = [];
let roundMastered = [];
let practiceAccum = [];
let practiceOrder = [];
let phase = 'learn';
let currentRaw = null;
let modalTimer = null;

/* ========== DOM ========= */
const screenDua = document.getElementById('screen-dua');
const screenMain = document.getElementById('screen-main');
const btnDoneDua = document.getElementById('btn-done-dua');

const statTotal = document.getElementById('stat-total');
const statMastered = document.getElementById('stat-mastered');
const statRemaining = document.getElementById('stat-remaining');
const statPhase = document.getElementById('stat-phase');

const arabicDiv = document.getElementById('arabic');
const learnControls = document.getElementById('learn-controls');
const btnKnow = document.getElementById('btn-know');
const btnDont = document.getElementById('btn-dont');
const btnAdd = document.getElementById('btn-add');
const btnReset = document.getElementById('btn-reset');
const messageDiv = document.getElementById('message');

const practiceArea = document.getElementById('practice-area');
const practiceInput = document.getElementById('practice-input');
const practiceSubmit = document.getElementById('practice-submit');
const practiceSkip = document.getElementById('practice-skip');

const modalRoot = document.getElementById('modal-root');

/* ========== Утилиты парсинга ========= */
function normalizeLine(l){
  if(!l) return '';
  return l.replace(/^\uFEFF/,'').replace(/[\u2010\u2011\u2012\u2013\u2014\u2015–—−]/g,'-').replace(/\s+/g,' ').trim();
}
function parseLine(raw){
  raw = normalizeLine(raw);
  const parts = raw.split(/[-–—]/).map(p=>p.trim()).filter(Boolean);
  const left = parts.length ? parts[0] : '';
  const rightParts = parts.slice(1);
  const rus = left ? left.split(',').map(s=>s.trim()).filter(Boolean) : [];
  const arabParts = rightParts.length ? rightParts.join(' - ').split(/\s*-\s*/).map(s=>s.trim()).filter(Boolean) : [];
  return { rawLine: raw, rus, arabParts, arabFull: rightParts.join(' - ') || '' };
}
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ========== Сохранение/восстановление ========= */
function saveState(){
  try{
    const st = { allRaw: allWords.map(w=>w.rawLine), orderQueue: orderQueue.slice(), masteredFinal, roundMastered, practiceAccum, practiceOrder, phase, currentRaw };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  }catch(e){ console.warn('saveState', e); }
}
function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):null; }catch(e){return null;} }
function clearState(){ try{ localStorage.removeItem(STORAGE_KEY);}catch(e){} }

/* ========== Загрузка words.txt (robust) ========= */
async function robustFetchWords(){
  const tries = ['words.txt','./words.txt'];
  try{ tries.push(location.pathname.replace(/\/[^/]*$/,'/') + 'words.txt'); }catch(e){}
  for(const p of tries){
    try{ const r = await fetch(p); if(r.ok) return await r.text(); }catch(e){}
  }
  try{
    const user = location.hostname.split('.')[0] || '';
    const repo = (location.pathname.split('/').filter(Boolean)[0] || '');
    if(user && repo){
      const raw = `https://raw.githubusercontent.com/${user}/${repo}/main/words.txt`;
      const r = await fetch(raw);
      if(r.ok) return await r.text();
    }
  }catch(e){}
  throw new Error('Не удалось загрузить words.txt');
}

/* ========== Инициализация словаря и восстановление ========= */
async function initDictionary(){
  const txt = await robustFetchWords();
  const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const parsed = lines.map(parseLine);
  const st = loadState();
  if(st && Array.isArray(st.allRaw) && st.allRaw.length){
    allWords = parsed.slice();
    const serverSet = new Set(allWords.map(w=>w.rawLine));
    orderQueue = (Array.isArray(st.orderQueue) ? st.orderQueue.filter(r=>serverSet.has(r)) : []);
    const oldSnap = new Set(st.allRaw || []);
    const newOnServer = allWords.map(w=>w.rawLine).filter(r => !oldSnap.has(r));
    for(const r of newOnServer) if(!orderQueue.includes(r)) orderQueue.push(r);
    masteredFinal = (Array.isArray(st.masteredFinal) ? st.masteredFinal.filter(r=>serverSet.has(r)) : []);
    roundMastered = (Array.isArray(st.roundMastered) ? st.roundMastered.filter(r=>serverSet.has(r)) : []);
    practiceAccum = (Array.isArray(st.practiceAccum) ? st.practiceAccum.filter(r=>serverSet.has(r)) : []);
    practiceOrder = (Array.isArray(st.practiceOrder) ? st.practiceOrder.filter(r=>serverSet.has(r)) : []);
    phase = st.phase || 'learn';
    currentRaw = (st.currentRaw && serverSet.has(st.currentRaw)) ? st.currentRaw : null;
    if(!orderQueue.length){
      orderQueue = allWords.map(w=>w.rawLine).filter(r => !masteredFinal.includes(r));
      shuffle(orderQueue);
    }
  } else {
    allWords = parsed.slice();
    masteredFinal = []; roundMastered = []; practiceAccum = []; practiceOrder = [];
    phase = 'learn'; currentRaw = null;
    orderQueue = allWords.map(w=>w.rawLine);
    shuffle(orderQueue);
  }
  updateStats();
  saveState();
}

/* ========== UI helpers ========= */
function updateStats(){
  statTotal.textContent = allWords.length;
  statMastered.textContent = masteredFinal.length;
  statRemaining.textContent = orderQueue.length;
  statPhase.textContent = phase === 'learn' ? 'Заучивание' : (phase === 'practice' ? 'Практика' : 'Готово');
}
function showMessage(t){ messageDiv.textContent = t || ''; }

/* ========== Заучивание: показать следующее слово ========= */
function showNextLearn(){
  phase = 'learn';
  // при заучивании — показываем кнопки "Знаю/Не знаю"
  learnControls.classList.remove('hidden');
  practiceArea.classList.add('hidden');
  updateStats();
  if(orderQueue.length === 0){
    if(roundMastered.length >= BATCH_SIZE){
      startPractice();
      return;
    } else {
      if(practiceAccum.length === 0){
        arabicDiv.textContent = 'Слов в очереди нет.';
        showMessage('Очередь пуста — нажмите "Добавить новые слова" или сбросьте прогресс.');
        saveState();
        return;
      } else {
        arabicDiv.textContent = 'Осталось немного слов — продолжайте заучивание.';
        showMessage('Если хотите перейти в практику — доведите раунд до ' + BATCH_SIZE + ' выученных.');
        saveState();
        return;
      }
    }
  }

  currentRaw = orderQueue.shift();
  const obj = allWords.find(w=>w.rawLine===currentRaw) || { rawLine: currentRaw, rus:[], arabParts:[], arabFull:'' };
  arabicDiv.textContent = obj.arabFull || (obj.arabParts||[]).join(' - ') || '[нет арабского]';
  showMessage('Нажмите "Знаю" или "Не знаю".');
  saveState();
  updateStats();
}

/* ========== Кнопки заучивания ========= */
btnKnow.addEventListener('click', () => {
  if(!currentRaw) return;
  if(!roundMastered.includes(currentRaw)) roundMastered.push(currentRaw);
  if(!practiceAccum.includes(currentRaw)) practiceAccum.push(currentRaw);
  currentRaw = null;
  saveState();
  updateStats();
  if(roundMastered.length >= BATCH_SIZE){
    startPractice();
  } else {
    showNextLearn();
  }
});

btnDont.addEventListener('click', () => {
  if(!currentRaw) return;
  const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
  showDontKnowModal(obj);
  orderQueue.push(currentRaw);
  currentRaw = null;
  saveState();
  updateStats();
});

/* ========== Модалка "Не знаю" ========= */
function showDontKnowModal(obj){
  closeModal();
  const overlay = document.createElement('div'); overlay.className='overlay';
  const modal = document.createElement('div'); modal.className='modal';
  let pairsHtml = '';
  const arParts = obj.arabParts && obj.arabParts.length ? obj.arabParts : (obj.arabFull ? obj.arabFull.split(/\s*-\s*/).map(s=>s.trim()) : []);
  if(obj.rus.length && arParts.length && obj.rus.length === arParts.length){
    for(let i=0;i<obj.rus.length;i++){
      pairsHtml += `<div class="pair">${escapeHtml(obj.rus[i])} — <span style="direction:rtl">${escapeHtml(arParts[i])}</span></div>`;
    }
  } else {
    const arabAll = arParts.join(' - ');
    for(const r of obj.rus.length?obj.rus:['']){
      pairsHtml += `<div class="pair">${escapeHtml(r)} — <span style="direction:rtl">${escapeHtml(arabAll)}</span></div>`;
    }
  }
  modal.innerHTML = `<div><strong>Перевод (показывается 15 с)</strong></div><div class="arab" style="margin-top:8px">${escapeHtml((arParts.join(' - ')) || obj.arabFull || '')}</div><div style="margin-top:8px">${pairsHtml}</div>`;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
  modalTimer = setTimeout(()=>{ closeModal(); showNextLearn(); }, SHOW_ANSWER_MS);
}

/* ========== Модалка для практики (показываем ответ при ошибке) ========= */
function showPracticeAnswerModal(obj){
  closeModal();
  const overlay = document.createElement('div'); overlay.className='overlay';
  const modal = document.createElement('div'); modal.className='modal';
  let pairsHtml = '';
  const arParts = obj.arabParts && obj.arabParts.length ? obj.arabParts : (obj.arabFull ? obj.arabFull.split(/\s*-\s*/).map(s=>s.trim()) : []);
  if(obj.rus.length && arParts.length && obj.rus.length === arParts.length){
    for(let i=0;i<obj.rus.length;i++){
      pairsHtml += `<div class="pair">${escapeHtml(obj.rus[i])} — <span style="direction:rtl">${escapeHtml(arParts[i])}</span></div>`;
    }
  } else {
    const arabAll = arParts.join(' - ');
    for(const r of obj.rus.length?obj.rus:['']){
      pairsHtml += `<div class="pair">${escapeHtml(r)} — <span style="direction:rtl">${escapeHtml(arabAll)}</span></div>`;
    }
  }
  modal.innerHTML = `<div><strong>Правильный ответ (показывается 15 с)</strong></div><div style="margin-top:8px">${pairsHtml}</div>`;
  overlay.appendChild(modal);
  modalRoot.appendChild(overlay);
  modalTimer = setTimeout(()=>{ closeModal(); showNextPractice(); }, SHOW_ANSWER_MS);
}

function closeModal(){ modalRoot.innerHTML=''; if(modalTimer){ clearTimeout(modalTimer); modalTimer=null; } }

/* ========== Практика ========= */
function startPractice(){
  phase = 'practice';
  // при практике — СКРЫВАЕМ блок learn-controls и показываем practice-area
  learnControls.classList.add('hidden');
  practiceArea.classList.remove('hidden');

  practiceOrder = practiceAccum.slice();
  shuffle(practiceOrder);
  roundMastered = [];
  saveState();
  updateStats();
  showNextPractice();
}

function showNextPractice(){
  if(!practiceOrder || practiceOrder.length === 0){
    phase = 'learn';
    // вернуть learn-controls видимыми и скрыть practice-area
    learnControls.classList.remove('hidden');
    practiceArea.classList.add('hidden');

    saveState();
    updateStats();
    showNextLearn();
    return;
  }
  currentRaw = practiceOrder.shift();
  const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
  arabicDiv.textContent = obj.arabFull || (obj.arabParts||[]).join(' - ') || '[нет арабского]';
  practiceArea.classList.remove('hidden');
  practiceInput.value = '';
  practiceInput.focus();
  updateStats();
}

practiceSubmit.addEventListener('click', () => {
  if(!currentRaw) return;
  const val = (practiceInput.value||'').trim().toLowerCase();
  if(!val) return;
  const obj = allWords.find(w=>w.rawLine===currentRaw) || parseLine(currentRaw);
  const ok = (obj.rus||[]).some(r => r.trim().toLowerCase() === val || r.trim().toLowerCase() === val.replace(/ё/g,'е'));
  if(ok){
    if(!masteredFinal.includes(currentRaw)) masteredFinal.push(currentRaw);
    practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
    showMessage('Верно — слово отмечено как окончательно выученное.');
    saveState();
    updateStats();
    currentRaw = null;
    showNextPractice();
  } else {
    orderQueue.push(currentRaw);
    practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
    saveState();
    updateStats();
    showPracticeAnswerModal(obj);
    currentRaw = null;
  }
});

practiceSkip.addEventListener('click', () => {
  if(!currentRaw) return;
  orderQueue.push(currentRaw);
  practiceAccum = practiceAccum.filter(r=>r!==currentRaw);
  saveState();
  updateStats();
  currentRaw = null;
  showNextPractice();
});

/* ========== Добавить новые слова (только новые) ========= */
btnAdd.addEventListener('click', async () => {
  try{
    const txt = await robustFetchWords();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const existing = new Set(allWords.map(w=>w.rawLine));
    let added = 0;
    for(const l of lines){
      const n = normalizeLine(l);
      if(!existing.has(n)){
        const obj = parseLine(n);
        allWords.push(obj);
        orderQueue.push(obj.rawLine);
        existing.add(n);
        added++;
      }
    }
    if(added) shuffle(orderQueue);
    saveState();
    updateStats();
    alert('Добавлено новых слов: ' + added);
  }catch(e){
    alert('Не удалось добавить слова: ' + e.message);
  }
});

/* ========== Сброс прогресса — сразу (без confirm) ========= */
btnReset.addEventListener('click', () => {
  clearState();
  orderQueue = allWords.map(w=>w.rawLine);
  shuffle(orderQueue);
  masteredFinal = []; roundMastered = []; practiceAccum = []; practiceOrder = []; phase='learn'; currentRaw=null;
  screenMain.classList.add('hidden');
  screenDua.classList.remove('hidden');
  updateStats();
});

/* ========== "Я сделал дуа" ========= */
btnDoneDua.addEventListener('click', async () => {
  screenDua.classList.add('hidden');
  screenMain.classList.remove('hidden');
  if(!allWords.length){
    try{ await initDictionary(); }catch(e){ alert('Ошибка загрузки слов: ' + e.message); return; }
  }
  if(phase === 'practice' && practiceOrder.length){
    learnControls.classList.add('hidden');
    practiceArea.classList.remove('hidden');
    showNextPractice();
  } else {
    practiceArea.classList.add('hidden');
    learnControls.classList.remove('hidden');
    if(currentRaw){
      const o = allWords.find(w=>w.rawLine===currentRaw);
      arabicDiv.textContent = (o && (o.arabFull || o.arabParts.join(' - '))) || currentRaw;
    } else showNextLearn();
  }
});

/* ========== Init bootstrap ========= */
(async function bootstrap(){
  try{
    await initDictionary();
    screenDua.classList.remove('hidden'); screenMain.classList.add('hidden');
  }catch(e){
    console.error(e);
    alert('Ошибка инициализации: ' + e.message);
  }
})();

/* ========== Save on leave ========= */
window.addEventListener('beforeunload', saveState);
window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveState(); });

</script>
</body>
</html>
